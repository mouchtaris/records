#!/usr/bin/env bash

source libbootstrap.bash

###
### ## Argument Check
###

#
# Check for correct number of arguments
#
if [[ $(($#)) < 1 ]]
then
  _err_and_die "$( printf 'Syntax:\n  %s ENV\n\n  ENV:\n    One of the environments in %s' "$0" "$_envs_dir" )"
fi

#
# Extract ENV arg
#
env=$1; shift;
if [ -z "$env" ]
then
  _err_and_die 'ENV (argv[0]) cannot be empty'
fi

###
### ## Configuration
###

#
# Configure according to ENV
#
_configure "$env"

###
### ## Subcommand dispatch
###

#
# If a subcommand is given, evaluate
#
if [ -n "$1" ]
then
  # Extra arguments given.
  # Dispatch to command:
  comm=_"$1"; shift;
  eval $comm ${@}
  exit $?
fi

###
### ## Installations
###

#
# If no subcommand is given, install the following packages
# in the following order
#
pkgs=(
  directories
  pyenv
  venv
  pip
  pipenv
)
#   python \
#   psycopg \
#   airflow
for pkg in "${pkgs[@]}"
do
  _install_pkg "$pkg" || _err_and_die "$( printf 'Failed while installing unless installed: %s' "$pkg" )"
done &&
exit 0 ||
exit 1

sudo mkdir -p /var/postgresql &&
sudo chmod 777 /var/postgresql &&
pg_ctl initdb &&
pg_ctl start &&
createuser airf &&
createdatabase airf &&
true
